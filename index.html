<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growplants</title>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #e8f5e9, #c8e6c9);
            color: #333;
        }
        header {
            background: #2e7d32;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .hamburger {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: white;
        }
        .menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 15px;
            background: #1b5e20;
            list-style: none;
            padding: 0;
            margin: 0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .menu li {
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid #4caf50;
        }
        .menu li:last-child { border: none; }
        .menu li:hover { background: #388e3c; }

        section {
            padding: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }
        #home { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .plants-grid img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .plants-grid img:hover { transform: scale(1.05); }

        footer {
            background: #2e7d32;
            color: white;
            text-align: center;
            padding: 12px;
            margin-top: 30px;
            font-size: 0.9em;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            transition: 0.3s;
        }
        button:hover { background: #388e3c; }
        button:disabled { background: #a5d6a7; cursor: not-allowed; }

        #qrCode { text-align: center; margin: 20px 0; display: none; }
        #qrCode img { width: 220px; height: 220px; border: 8px solid white; border-radius: 12px; }

        video { width: 100%; max-width: 400px; border-radius: 12px; margin: 10px 0; }
        canvas { display: none; }

        .status { padding: 10px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>

<header>
    <h1>Growplants</h1>
    <div class="hamburger" onclick="toggleMenu()">â˜°</div>
    <ul class="menu" id="menu">
        <li onclick="showSection('home')">Home</li>
        <li onclick="showSection('about')">About</li>
        <li onclick="showSection('ads')">Ads</li>
        <li onclick="showSection('shop')">Shop</li>
        <li onclick="showSection('partnership')">Partnership</li>
        <li onclick="showSection('earn')">Earn Reward</li>
    </ul>
</header>

<!-- HOME -->
<section id="home">
    <h2>Welcome to Growplants</h2>
    <p>Grow plants, earn B3TR tokens!</p>
    <div class="plants-grid">
        <img src="https://images.unsplash.com/photo-1453904300235-0f2f60d4383a?w=400" alt="Growing Plant 1">
        <img src="https://images.unsplash.com/photo-1594736797933-d0501ba2fe65?w=400" alt="Growing Plant 2">
        <img src="https://images.unsplash.com/photo-1587302164676-0a002a2e8b62?w=400" alt="Growing Plant 3">
    </div>
    <footer>
        <p>Contact: <a href="https://twitter.com/yourusername" style="color:#bbdefb;">@yourusername</a></p>
    </footer>
</section>

<!-- ABOUT -->
<section id="about">
    <h2>About</h2>
    <h3>Benefits of Growing Plants</h3>
    <ul>
        <li>Cleaner air & more oxygen</li>
        <li>Reduces stress & anxiety</li>
        <li>Beautiful home decoration</li>
        <li>Learn responsibility</li>
    </ul>
    <h3>Rewards</h3>
    <p>Take a clear photo of your plant â†’ Earn <strong>0.5 B3TR</strong></p>
    <h3>Rules</h3>
    <ul>
        <li>Photo must be real & clear</li>
        <li>No blur, no edits</li>
        <li>One reward per plant per week</li>
    </ul>
</section>

<!-- COMING SOON -->
<section id="ads"><h2>Ads</h2><p>Coming Soon!</p></section>
<section id="shop"><h2>Shop</h2><p>Coming Soon!</p></section>
<section id="partnership"><h2>Partnership</h2><p>Coming Soon!</p></section>

<!-- EARN REWARD -->
<section id="earn">
    <h2>Earn 0.5 B3TR</h2>
    <button id="connectBtn">Connect VeWorld Wallet</button>
    <div id="status"></div>

    <div id="qrCode">
        <p>Scan with <strong>VeWorld App</strong></p>
        <div id="qrcode"></div>
    </div>

    <div id="cameraSection" style="display:none; text-align:center;">
        <button id="openCamera">ðŸ“· Open Camera</button>
        <video id="video" autoplay playsinline></video>
        <button id="capture" style="display:none;">Capture Photo</button>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result"></div>
</section>

<script>
    let userAddress = null;
    let stream = null;

    function toggleMenu() {
        const menu = document.getElementById('menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        toggleMenu();
    }

    // === CONNECT WALLET ===
    document.getElementById('connectBtn').onclick = () => {
        const btn = document.getElementById('connectBtn');
        btn.disabled = true;
        btn.textContent = 'Connecting...';

        // Generate QR URI (VeWorld deep link demo)
        const dappId = 'growplants';
        const message = 'Connect to Growplants for B3TR rewards';
        const uri = `veworld://dapp/connect?dappId=${dappId}&message=${encodeURIComponent(message)}`;

        // Show QR Code
        const qrCodeDiv = document.getElementById('qrCode');
        qrCodeDiv.style.display = 'block';
        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = '';
        QRCode.toCanvas(qrDiv, uri, { width: 220 }, (err) => {
            if (err) {
                console.error('QR Error:', err);
                qrDiv.innerHTML = '<p>QR Generation Failed</p>';
            }
        });

        // Try to open VeWorld app (mobile deep link)
        window.location.href = uri;

        // Mock connect after 5 seconds (for testing; remove in production)
        setTimeout(() => {
            if (!userAddress) {
                userAddress = '0xMockAddress...ForTesting'; // Mock address
                document.getElementById('status').innerHTML = `<div class="status success">Wallet Connected: ${userAddress}</div>`;
                document.getElementById('cameraSection').style.display = 'block';
                qrCodeDiv.style.display = 'none';
                btn.style.display = 'none';
            }
        }, 5000);
    };

    // === CAMERA ===
    document.getElementById('openCamera').onclick = async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } // Back camera for plants
            });
            const video = document.getElementById('video');
            video.srcObject = stream;
            document.getElementById('capture').style.display = 'block';
        } catch (err) {
            document.getElementById('result').innerHTML = `<div class="status error">Camera error: ${err.message}. Allow camera access.</div>`;
        }
    };

    document.getElementById('capture').onclick = () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Stop camera
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
        }
        video.srcObject = null;
        document.getElementById('capture').style.display = 'none';

        const img = new Image();
        img.src = canvas.toDataURL();
        img.onload = () => {
            if (isBlurry(img)) {
                document.getElementById('result').innerHTML = `<div class="status error">Error: Photo is blurry. Not valid for reward. Try again!</div>`;
            } else {
                document.getElementById('result').innerHTML = `
                    <div class="status success">
                        <strong>Great Photo!</strong><br>
                        0.5 B3TR Token rewarded to your wallet.<br>
                        <small>(Check VeWorld App - Mock for demo)</small>
                    </div>`;
            }
        };
    };

    // === BLUR DETECTION (Improved) ===
    function isBlurry(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        let gray = [];
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            gray.push(avg);
        }

        let laplacianVariance = 0;
        let count = 0;
        const width = canvas.width;
        for (let y = 1; y < canvas.height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = y * width + x;
                const sum = Math.abs(-gray[idx - width - 1] - 8 * gray[idx] + gray[idx - width + 1] +
                                     gray[idx - 1] + gray[idx + 1] +
                                     gray[idx + width - 1] + gray[idx + width] + gray[idx + width + 1]);
                laplacianVariance += sum * sum;
                count++;
            }
        }
        laplacianVariance = laplacianVariance / (count || 1);
        return laplacianVariance < 100; // Threshold: lower = blurrier
    }
</script>

</body>
</html>
